<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Syqlorix → APK (browser-built)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
 :root{--bg:#0d1117;--fg:#c9d1d9;--accent:#00a8cc;--panel:#161b22;--border:#30363d}
 body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui;display:flex;flex-direction:column;min-height:100vh}
 header{background:var(--panel);padding:.75rem 1rem;font-weight:600}
 main{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}
 .pane{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:1rem}
 .editor{height:320px;border:1px solid var(--border);border-radius:4px;background:#0d1117;color:#e6edf3;padding:.5rem;font-family:ui-monospace,monospace;overflow:auto}
 .dropzone{border:2px dashed var(--accent);border-radius:6px;padding:2rem;text-align:center;cursor:pointer}
 .dropzone.dragover{background:var(--border)}
 button{background:var(--accent);border:none;border-radius:4px;padding:.5rem 1rem;color:#fff;cursor:pointer}
 button:disabled{opacity:.5;cursor:not-allowed}
 progress{width:100%;height:4px}
 @media(max-width:768px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>Syqlorix → Android APK (browser-built)</header>

<main>
  <!-- LEFT: upload + tree -->
  <div class="pane flex flex-col gap-3">
    <label class="font-semibold">Upload source</label>
    <input id="picker" type="file" multiple webkitdirectory hidden/>
    <input id="zipPicker" type="file" accept=".zip" hidden/>
    <input id="pyPicker" type="file" accept=".py" hidden/>
    <div id="dropzone" class="dropzone">
      Drop folder / .zip / .py or <u>browse</u><br>
      <small class="text-gray-400">no servers, no buildozer</small>
      <div class="mt-2 space-x-2">
        <button onclick="picker.click()">Folder</button>
        <button onclick="zipPicker.click()">.zip</button>
        <button onclick="pyPicker.click()">.py</button>
      </div>
    </div>

    <label class="font-semibold">Entry file</label>
    <select id="entrySelect" class="bg-[#161b22] border border-[#30363d] rounded px-2 py-1"></select>

    <label class="font-semibold">APK Tree</label>
    <pre id="treePreview" class="editor"></pre>
  </div>

  <!-- RIGHT: APK config -->
  <div class="pane flex flex-col gap-3">
    <label class="font-semibold">Package</label>
    <input id="pkg" value="com.example.syqlorix" class="bg-[#161b22] border border-[#30363d] rounded px-2 py-1"/>
    <label class="font-semibold">App label</label>
    <input id="label" value="Syqlorix App" class="bg-[#161b22] border border-[#30363d] rounded px-2 py-1"/>

    <button id="buildBtn" disabled class="mt-auto">Build APK</button>
    <progress id="progress" style="display:none"></progress>
    <a id="dl" class="hidden text-center bg-[#00a8cc] text-white rounded px-3 py-1">⬇ Download APK</a>
  </div>
</main>

<!-- WASM runtime -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/webapk@1.1.0/dist/webapk.min.js"></script>

<script type="module">
const picker   = document.getElementById('picker');
const zipPicker= document.getElementById('zipPicker');
const pyPicker = document.getElementById('pyPicker');
const dropzone = document.getElementById('dropzone');
const entrySel = document.getElementById('entrySelect');
const treePrev = document.getElementById('treePreview');
const buildBtn = document.getElementById('buildBtn');
const progress = document.getElementById('progress');
const dl       = document.getElementById('dl');
const pkgIn    = document.getElementById('pkg');
const labelIn  = document.getElementById('label');

let files = [];

['dragenter','dragover'].forEach(e=>dropzone.addEventListener(e, ev=>{ev.preventDefault();dropzone.classList.add('dragover')}));
['dragleave','drop'].forEach(e=>dropzone.addEventListener(e, ev=>dropzone.classList.remove('dragover')));
dropzone.addEventListener('drop', handleFiles);
[picker, zipPicker, pyPicker].forEach(el=>el.addEventListener('change', handleFiles));

async function handleFiles(e){
  const raw = [...(e.target.files || e.dataTransfer.files)];
  files = [];
  // single .zip
  if(raw.length===1 && raw[0].name.endsWith('.zip')){
    const zip = await JSZip.loadAsync(raw[0]);
    zip.forEach((path,file)=>{if(!file.dir) files.push({path,file});});
  }else if(raw.length===1 && raw[0].name.endsWith('.py')){
    files=[{path:'main.py', file:raw[0]}];
  }else{ // folder
    files = raw.filter(f=>!f.isDirectory).map(f=>({path:f.webkitRelativePath.split('/').slice(1).join('/'), file:f}));
  }
  populateEntries();
  previewTree();
}

function populateEntries(){
  const pyFiles = files.filter(f=>f.path.endsWith('.py')).map(f=>f.path);
  entrySel.innerHTML='';
  pyFiles.forEach(p=>{const o=document.createElement('option');o.value=o.textContent=p;entrySel.appendChild(o)});
  buildBtn.disabled = pyFiles.length===0;
}

function previewTree(){
  treePrev.textContent = files.map(f=>f.path).sort().join('\n');
}

buildBtn.onclick = async () => {
  buildBtn.disabled = true;
  progress.style.display = 'block';
  dl.classList.add('hidden');

  // create zip for WebAPK
  const zip = new JSZip();
  const entry = entrySel.value;
  for(const {path,file} of files){
    zip.file(path, file);
  }
  // android wrapper
  const wrapper = `from kivy.app import App
from kivy.uix.webview import WebView
import threading, os, sys
sys.path.insert(0, os.getcwd())
exec(open('${entry}').read())  # loads Syqlorix 'doc'
class Wrapper(App):
    def build(self):
        threading.Thread(target=lambda: doc.run(file_path='${entry}',host='127.0.0.1',port=5000),daemon=True).start()
        return WebView(url='http://127.0.0.1:5000')
Wrapper().run()`;
  zip.file('main.py', wrapper);

  const blob = await zip.generateAsync({type:'blob'}, meta=>progress.value=meta.percent);

  // build APK in browser
  const apk = await WebAPK.build({
    package: pkgIn.value,
    label: labelIn.value,
    sourceZip: blob,
    entry: 'main.py'
  });

  dl.href = URL.createObjectURL(apk);
  dl.download = 'app-debug.apk';
  dl.classList.remove('hidden');
  progress.style.display = 'none';
  buildBtn.disabled = false;
};
</script>
</body>
</html>